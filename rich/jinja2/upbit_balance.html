{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-2 sm:px-4 py-4 sm:py-8">
    <h1 class="text-lg sm:text-2xl font-bold mb-4 sm:mb-6">업비트 잔고 현황 at {{ created.astimezone().strftime('%H:%M
        %Y/%m/%d') }}</h1>

    <!-- 합계 정보 -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 sm:gap-4 mb-4">
        <div class="bg-white rounded-lg shadow p-3 sm:p-6">
            <h3 class="text-sm sm:text-lg font-semibold text-gray-700 mb-1 sm:mb-2">총 자산</h3>
            <p class="text-lg sm:text-2xl font-bold text-gray-900">{{ '{:,.0f}'.format(total_value) }}원</p>
        </div>
        <div class="bg-white rounded-lg shadow p-3 sm:p-6">
            <h3 class="text-sm sm:text-lg font-semibold text-gray-700 mb-1 sm:mb-2">코인 자산</h3>
            <p class="text-lg sm:text-2xl font-bold text-gray-900">{{ '{:,.0f}'.format(total_coin_value) }}원</p>
            <p class="text-xs sm:text-md text-gray-600 mt-1">{{ '{:.2f}%'.format(total_coin_value / total_value * 100)
                }}</p>
        </div>
        <div class="bg-white rounded-lg shadow p-3 sm:p-6">
            <h3 class="text-sm sm:text-lg font-semibold text-gray-700 mb-1 sm:mb-2">원화 잔고</h3>
            <p class="text-lg sm:text-2xl font-bold text-gray-900">{{ '{:,.0f}'.format(krw_value) }}원</p>
            <p class="text-xs sm:text-md text-gray-600 mt-1">{{ '{:.2f}%'.format(krw_weight) }}</p>
        </div>
    </div>

    <!-- 잔고 테이블 -->
    <div class="overflow-x-auto bg-white rounded-lg shadow">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th
                        class="px-1 sm:px-2 py-1 sm:py-2 text-left text-[12px] sm:text-sm font-medium text-gray-500 uppercase tracking-wider">
                        코인</th>
                    <th
                        class="px-1 sm:px-2 py-1 sm:py-2 text-right text-[12px] sm:text-sm font-medium text-gray-500 uppercase tracking-wider">
                        평균/수량/비중/수익률</th>
                    <th
                        class="px-1 sm:px-2 py-1 sm:py-2 text-right text-[12px] sm:text-sm font-medium text-gray-500 uppercase tracking-wider">
                        현재가</th>
                    <th
                        class="px-1 sm:px-2 py-1 sm:py-2 text-right text-[12px] sm:text-sm font-medium text-gray-500 uppercase tracking-wider">
                        평가금액</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {%- for balance in balances %}
                {%- set profit_rate = (balance.current_price / balance.avg_buy_price * 100 - 100) if
                balance.avg_buy_price else None %}
                <tr>
                    <td
                        class="px-1 sm:px-2 py-1 sm:py-2 whitespace-nowrap text-[12px] sm:text-base font-medium text-gray-900">
                        <div>
                            <div>{{ balance.symbol }}</div>
                            {%- if balance.is_staking %}
                            <div
                                class="text-[10px] sm:text-xs text-blue-600 font-medium bg-blue-100 px-2 py-0.5 rounded-full inline-block">
                                Staking</div>
                            {%- endif %}
                        </div>
                    </td>
                    <td class="px-1 sm:px-2 py-1 sm:py-2 text-center text-[12px] sm:text-sm text-gray-900">
                        <div class="space-y-0.5">
                            <div class="text-right">
                                {{ balance.avg_buy_price_display if balance.avg_buy_price else '-' }}
                            </div>
                            <div class="text-right">{{ balance.quantity_display }}</div>
                            <div class="text-right text-gray-600">
                                {{ '{:.2f}%'.format(balance.weight) }}
                            </div>
                            <div
                                class="text-right {{ 'text-green-600' if profit_rate and profit_rate > 0 else 'text-red-600' if profit_rate and profit_rate < 0 else 'text-gray-900' }}">
                                {{ '{:.2f}%'.format(profit_rate) if profit_rate is not none else '-' }}
                            </div>
                        </div>
                    </td>
                    <td
                        class="px-1 sm:px-2 py-1 sm:py-2 whitespace-nowrap text-[12px] sm:text-sm text-right text-gray-900">
                        {{ balance.current_price_display }}
                        {%- if price_changes and balance.symbol in price_changes %}
                        <div class="text-[12px] sm:text-xs mt-0.5">
                            {%- for change_index in range(3) %}
                            {%- set actual_index = change_index * 2 if price_changes[balance.symbol]|length > 3 else
                            change_index %}
                            {%- if price_changes[balance.symbol]|length > actual_index %}
                            {%- set change = price_changes[balance.symbol][actual_index] %}
                            {%- set historical_price = historical_prices[balance.symbol][actual_index] if
                            historical_prices and balance.symbol in historical_prices and
                            historical_prices[balance.symbol]|length > actual_index else '' %}
                            {%- set timestamp = price_change_timestamps[balance.symbol][actual_index] if
                            price_change_timestamps and balance.symbol in price_change_timestamps and
                            price_change_timestamps[balance.symbol]|length > actual_index else '' %}
                            <div class="{{ 'text-green-600' if change >= 0 else 'text-red-600' }} cursor-pointer hover:bg-gray-100 px-1 rounded"
                                title="{{ timestamp.strftime('%m/%d %H:%M') + ' - ₩' + '{:,.0f}'.format(historical_price) if timestamp and historical_price else '' }}"
                                onclick="showTooltip(event, '{{ timestamp.strftime('%m/%d %H:%M') if timestamp else '' }}', '{{ '{:,.0f}'.format(historical_price) if historical_price else '' }}')">
                                {{ '{:.2f}%'.format(change) }}
                            </div>
                            {%- endif %}
                            {%- endfor %}
                        </div>
                        {%- endif %}
                    </td>
                    <td
                        class="px-1 sm:px-2 py-1 sm:py-2 whitespace-nowrap text-[12px] sm:text-sm text-right text-right text-gray-900">
                        {{ '{:,.0f}'.format(balance.value) }}
                        {%- if price_changes and balance.symbol in price_changes %}
                        <div class="text-[12px] sm:text-xs mt-0.5">
                            {%- for change_index in range(3) %}
                            {%- set actual_index = change_index * 2 if price_changes[balance.symbol]|length > 3 else
                            change_index %}
                            {%- if price_changes[balance.symbol]|length > actual_index %}
                            {%- set change = price_changes[balance.symbol][actual_index] %}
                            {%- set change_amount = (Decimal(balance.value) * change / 100) %}
                            {%- set historical_price = historical_prices[balance.symbol][actual_index] if
                            historical_prices and balance.symbol in historical_prices and
                            historical_prices[balance.symbol]|length > actual_index else '' %}
                            {%- set timestamp = price_change_timestamps[balance.symbol][actual_index] if
                            price_change_timestamps and balance.symbol in price_change_timestamps and
                            price_change_timestamps[balance.symbol]|length > actual_index else '' %}
                            <div class="{{ 'text-green-600' if change >= 0 else 'text-red-600' }} cursor-pointer hover:bg-gray-100 px-1 rounded"
                                title="{{ timestamp.strftime('%m/%d %H:%M') + ' - ₩' + '{:,.0f}'.format(historical_price) if timestamp and historical_price else '' }}"
                                onclick="showTooltip(event, '{{ timestamp.strftime('%m/%d %H:%M') if timestamp else '' }}', '{{ '{:,.0f}'.format(historical_price) if historical_price else '' }}')">
                                {{ '{:+,.0f}'.format(change_amount) }}
                            </div>
                            {%- endif %}
                            {%- endfor %}
                        </div>
                        {%- endif %}
                    </td>
                </tr>
                {%- endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- 커스텀 툴팁 -->
<div id="custom-tooltip" class="fixed hidden bg-black text-white text-xs px-2 py-1 rounded pointer-events-none z-50">
</div>

<script>
    function showTooltip(event, timestamp, historical_price) {
        const tooltip = document.getElementById('custom-tooltip');
        if (timestamp) {
            const tooltipContent = timestamp + (historical_price ? ' - ₩' + historical_price : '');
            tooltip.textContent = tooltipContent;

            // 마우스 위치 기준으로 툴팁 위치 계산
            const mouseX = event.clientX;
            const mouseY = event.clientY;

            // 툴팁 크기 고려하여 위치 조정 (내용이 길어졌으므로 크기 증가)
            const tooltipWidth = 120; // 예상 툴팁 너비 증가
            const tooltipHeight = 24; // 예상 툴팁 높이

            // 화면 경계 체크
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;

            let left = mouseX + 10;
            let top = mouseY - tooltipHeight - 10;

            // 오른쪽 경계 체크
            if (left + tooltipWidth > windowWidth) {
                left = mouseX - tooltipWidth - 10;
            }

            // 위쪽 경계 체크
            if (top < 0) {
                top = mouseY + 20;
            }

            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
            tooltip.classList.remove('hidden');

            // 3초 후 자동으로 숨김
            setTimeout(() => {
                tooltip.classList.add('hidden');
            }, 3000);
        }
    }

    // 툴팁 외부 클릭 시 숨김
    document.addEventListener('click', function (event) {
        if (!event.target.hasAttribute('onclick')) {
            document.getElementById('custom-tooltip').classList.add('hidden');
        }
    });

    // 마우스가 툴팁 영역을 벗어날 때도 숨김
    document.addEventListener('mouseleave', function () {
        document.getElementById('custom-tooltip').classList.add('hidden');
    });
</script>
{% endblock %}